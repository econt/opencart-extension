<style>
    #econt-delivery-customer-info-modal iframe {
        border: 0;
        width: 100%;
        height: 608px;
    }
</style>
<div id="econt-delivery-customer-info-modal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">{{ heading_title }}</h4>
            </div>
            <div class="modal-body">
                <iframe src="about:blank" onload="$(document).trigger('econtFrameLoaded')"></iframe>
            </div>
        </div>
    </div>
</div>
<script>
    window.econtDelivery = window.econtDelivery || {
        empty: function (thingy) {
            return thingy == 0 || !thingy || (typeof (thingy) === 'object' && $.isEmptyObject(thingy));
        },
        systemUrl: '{{ econtDeliverySettings.shipping_econt_delivery_system_url }}',
        orderId: {{ order_id }},
        customerInfo: {}
    };
    $(function ($) {
        var $shippingMethod = $('#input-shipping-method');
        var $customerInfoWindow = $('#econt-delivery-customer-info-modal').modal({
            'show': false,
            'backdrop': 'static'
        });

        var $customerInfoLink = $('<a></a>').attr({
            'href': '#',
            'target': '_self'
        }).text('{{ text_edit_customer_info }}');
        $customerInfoLink.show = function () {
            $customerInfoLink.css({'display': 'inline-block'});
        }
        $customerInfoLink.hide = function () {
            $customerInfoLink.css({'display': 'none'});
        }
        $customerInfoLink.hide();
        $((((function ($parent) {
            return ((parseInt($parent.length, 10) || 0) <= 0 ? false : $parent);
        })($shippingMethod.parents('.input-group')) || $shippingMethod).parent())).append($customerInfoLink);

        $customerInfoLink.click(function (event) {
            event.preventDefault();

            $.ajax({
                url: '{{ get_customer_info_params_url }}',
                type: 'POST',
                data: {},
                dataType: 'json',
                async: false,
                success: function (response) {
                    if (!window.econtDelivery.empty(response['error'])) {
                        alert(response['error']);
                        return;
                    }

                    if (window.econtDelivery.empty(response['customer_info_url'])) {
                        alert('{{ text_empty_customer_info_url }}');
                        return;
                    }

                    $customerInfoWindow.find('iframe').attr('src', response['customer_info_url']);
                    $customerInfoWindow.modal('show');
                },
                error: function (xhr, textStatus, errorThrown) {
                    alert('{{ text_default_error_message }}');
                    console.error(errorThrown);
                }
            });
        });
        $(window).on('message', function (event) {
            if (event['originalEvent']['origin'] != window.econtDelivery.systemUrl) return;

            var messageData = event['originalEvent']['data'];
            if (!messageData) return;

            var withShippingError = false;
            if (!window.econtDelivery.empty(messageData['shipment_error'])) {
                withShippingError = true;
                alert(messageData['shipment_error']);
            }

            $.ajax({
                url: '{{ econt_delivery_before_api_url }}',
                type: 'POST',
                data: messageData,
                dataType: 'json',
                async: false, // <--- synchronious call, otherwise messes the session
                success: function (response) {
                    if (!withShippingError) {
                        $customerInfoWindow.modal('hide');
                    }
                    window.econtDelivery.customerInfo = response['customer_info'];
                }
            });
        });

        if ($shippingMethod.val() === 'econt_delivery.econt_delivery'){
            $customerInfoLink.show();
        } else {
            $customerInfoLink.hide();
        }

        $shippingMethod.change(function () {
            
            if ($(this).val() !== 'econt_delivery.econt_delivery'){
                $customerInfoLink.hide();
            }
            else {
                $customerInfoLink.show();
                if (window.econtDelivery.empty(window.econtDelivery.customerInfo)) {
                    // Give time for api/shipping/address to copmlete
                    $(document).on('econtFrameLoaded', function(){

                    });
                    $customerInfoLink.click()
                };
            }
        });

        var loadCustomerInfo = function (showWindow) {
            $.ajax({
                url: '{{ econt_delivery_before_api_no_action_url }}',
                type: 'POST',
                data: {},
                dataType: 'json',
                async: false,
                success: function (response) {
                    window.econtDelivery.customerInfo = response;
                    if (showWindow && showWindow === true && window.econtDelivery.empty(window.econtDelivery.customerInfo)) {
                        $shippingMethod.change();
                    }
                }
            });
        }
        $('#button-shipping-address').click(function () {
            setTimeout(function () {
                loadCustomerInfo(true);
            }, 200);
        });
        if (window.econtDelivery.empty(window.econtDelivery.customerInfo)){
            loadCustomerInfo(false)
        }
    });
</script>
